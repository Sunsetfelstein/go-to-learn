
Это примитив синхронизации, обеспечивающий взаимное исключения исполнения критических участков кода.

Критическая секция - область кода, которая находится между Lock и Unlock. И гарантия мьютекса в том, что в этот участок кода не может попасть больше одной горутины

![[Pasted image 20260118153652.png]]

Горутина имеет 3 различных состояния: 
* Running
* Ready
* Waiting

Если горутина пытается захватить мьютекс, который уже был кем-то захвачен, то горутина блокируется на мьютексе и переходит из состояния running в состояние waiting 

#### Гарантии мьютекса

Взаимное исключение (safety) - между lock и unlock может быть только одна горутина

Прогресс (liveness) - если одна или несколько горутин пытается захватить мьютекс, то один из вызовов mutex.Lock() должен завершиться успешно (горутины не должны мешать друг-другу бексонечно долго)

Для реализации мьютекса нужны атомарные операции, так как они содержат барьеры памяти. Это такие примитивы синхронизации, которые запрещают компилятору и процессору менять порядок вызова ваших методов. 

Процессоры и компиляторы могут переставлять порядок операций чтения/записи для повышения производительности:

``` go
// Исходный код
var x, y int
var ready bool

// Горутина 1
x = 42
y = 100
ready = true  // Флаг готовности

// Горутина 2
if ready {
    // Может ли здесь y быть 0, а x не 42?
    fmt.Println(x, y)
}
```

**Без барьеров памяти**:

- Процессор может выполнить `ready = true` ДО `x = 42` или `y = 100`
- Другая горутина увидит `ready == true`, но `x` или `y` еще не инициализирован
### **В Go барьеры реализованы через:**

1. **Атомарные операции** (`atomic.Add`, `atomic.Load`, `atomic.Store`)
2. **Каналы** (отправка и получение создают барьеры)
3. **Синхронизация** (`sync.Mutex`, `sync.RWMutex`, `sync.WaitGroup`)

Так же нужны RMW (Read-Modify-Write) операции. В голанг это операция CAS (Compare and swap, оно проверяет, соотвествует ли значение в ячейки памяти переданному значению, если да, то меняет на новое. 

``` go
if *addr == old {
	*addr = new
	return true
} 

return false
```

![[Pasted image 20260118232606.png]]

### **Что такое RWMutex?**

Это **мьютекс с разделением на чтение и запись** (Read-Write Mutex). Позволяет:

- **Множеству читателей** работать одновременно
- **Только одному писателю** работать в любой момент
- **Никогда не совмещать** читателей и писателей
  
``` go
var mu sync.RWMutex
var data map[string]int

// Читатели (могут быть много одновременно)
func read(key string) int {
    mu.RLock()          // Захват для чтения
    defer mu.RUnlock()  // Освобождение
    return data[key]
}

// Писатель (только один)
func write(key string, value int) {
    mu.Lock()           // Захват для записи
    defer mu.Unlock()   // Освобождение
    data[key] = value
}
```

### **Приоритеты в Go RWMutex**

1. **Читатели не блокируют других читателей**
2. **Писатель блокирует всех** (читателей и других писателей)
3. **Новый читатель может войти, только если нет ожидающих писателей** (чтобы предотвратить голодание писателей)

### Мьютексы и каналы

* Если нужно координировать горутины или отслеживать значение по мере его преобразования с помощью нескольких горутин, используйте каналы.

* Если нужно обеспечить совместный доступ к полю структуры, применяйте мьютекс

* Если вы выявили критическую проблему производительности при использовании каналов и не можете найти других способов ее решения, задействуйте вместо каналов мьютексы.

### В GO блокировке не повторно входимые 

То, что блокировки в Go не являются повторно входимыми, затрудняет установку блокировки внутри рекурсивных функций. В таких случаях следует снимать блокировку до вызова рекурсивной функции. 

И вообще старайтесь не вызывать функции при установленной блокировке, поскольку неизвестно, какие блокировки будут в них установлены. Если ваша функция вызовет другую функцию, которая попытается установить блокировку с тем же мьютексом, это приведет к зависанию горутины.

Как и типы sync.WaitGroup и sync.Once, мьютексы никогда не следует копировать. Если мьютекс передается в функцию или применяется как поле структуры, это следует делать посредством указателя. Если мьютекс будет скопирован, вы не сможете обеспечить совместное использование его блокировки.

